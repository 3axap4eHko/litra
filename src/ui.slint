component DimmerIcon inherits Rectangle {
    width: 23px;
    height: 23px;
    background: transparent;

    Path {
        width: 100%;
        height: 100%;
        fill: #ffffff;
        viewbox-width: 23;
        viewbox-height: 23;
        commands: "M11.5,17.601 C8.131,17.601 5.399,14.87 5.399,11.5 C5.399,8.13 8.131,5.399 11.5,5.399 C14.869,5.399 17.601,8.13 17.601,11.5 C17.601,14.87 14.869,17.601 11.5,17.601 M19.634,14.866 L23,11.5 L19.634,8.134 L19.634,3.366 L14.866,3.366 L11.5,0 L8.134,3.366 L3.366,3.366 L3.366,8.134 L0,11.5 L3.366,14.866 L3.366,19.634 L8.134,19.634 L11.5,23.001 L14.866,19.634 L19.634,19.634 Z";
    }
}

component BrighterIcon inherits Rectangle {
    width: 23px;
    height: 23px;
    background: transparent;

    Path {
        width: 100%;
        height: 100%;
        fill: #ffffff;
        viewbox-width: 23;
        viewbox-height: 23;
        commands: "M11.5,7.433 C9.254,7.433 7.433,9.254 7.433,11.5 C7.433,13.746 9.254,15.567 11.5,15.567 C13.746,15.567 15.567,13.746 15.567,11.5 C15.567,9.254 13.746,7.433 11.5,7.433 M11.5,17.601 C8.131,17.601 5.399,14.869 5.399,11.5 C5.399,8.131 8.131,5.399 11.5,5.399 C14.869,5.399 17.601,8.131 17.601,11.5 C17.601,14.869 14.869,17.601 11.5,17.601 M19.634,8.134 L19.634,3.366 L14.866,3.366 L11.5,0 L8.134,3.366 L3.366,3.366 L3.366,8.134 L0,11.5 L3.366,14.866 L3.366,19.634 L8.134,19.634 L11.5,23 L14.866,19.634 L19.634,19.634 L19.634,14.866 L23,11.5 Z";
    }
}

component WarmerIcon inherits Rectangle {
    width: 14px;
    height: 18px;
    background: transparent;

    Path {
        width: 100%;
        height: 100%;
        fill: #ffffff;
        viewbox-width: 14;
        viewbox-height: 18;
        commands: "M12.67,8.199 C12.44,7.899 12.16,7.641 11.9,7.379 C11.23,6.781 10.47,6.352 9.83,5.719 C8.341,4.262 8.011,1.852 8.961,0 C8.011,0.23 7.181,0.75 6.471,1.32 C3.882,3.399 2.862,7.071 4.082,10.219 C4.121,10.321 4.161,10.422 4.161,10.551 C4.161,10.77 4.012,10.969 3.812,11.051 C3.582,11.149 3.342,11.09 3.152,10.93 C3.092,10.879 3.052,10.828 3.012,10.762 C1.882,9.328 1.702,7.281 2.462,5.641 C0.792,7 -0.118,9.301 0.012,11.469 C0.072,11.969 0.132,12.469 0.302,12.969 C0.442,13.571 0.712,14.172 1.012,14.7 C2.092,16.43 3.962,17.672 5.971,17.922 C8.111,18.192 10.4,17.801 12.04,16.321 C13.87,14.661 14.51,12 13.57,9.719 L13.44,9.461 C13.23,9 12.67,8.199 12.67,8.199 M9.51,14.5 C9.23,14.739 8.771,15 8.411,15.102 C7.291,15.5 6.171,14.942 5.511,14.282 C6.701,14 7.411,13.121 7.621,12.231 C7.791,11.43 7.471,10.77 7.341,10 C7.221,9.262 7.241,8.629 7.511,7.942 C7.701,8.321 7.901,8.699 8.141,9 C8.911,10 10.12,10.442 10.38,11.801 C10.42,11.942 10.44,12.078 10.44,12.231 C10.47,13.051 10.11,13.95 9.51,14.5 Z";
    }
}

component ColderIcon inherits Rectangle {
    width: 22px;
    height: 20px;
    background: transparent;

    Path {
        width: 100%;
        height: 100%;
        fill: #ffffff;
        viewbox-width: 22;
        viewbox-height: 20;
        commands: "M13.25,10 L15.27,8.98 L22,8.98 L21,6.939 L17.03,6.939 L19.42,3.702 L18.43,1.661 L14.37,7.146 L12.35,8.174 L12.75,5.918 L16.83,0.426 L14.64,0.019 L11,4.898 L7.4,0.003 L5.2,0.41 L9.26,5.918 L9.66,8.174 L7.82,7.234 L7.66,7.154 L3.6,1.629 L2.6,3.67 L5,6.939 L1,6.939 L0,8.98 L6.77,8.98 L8.75,10 L6.73,11.02 L0,11.02 L1,13.061 L4.97,13.061 L2.58,16.298 L3.57,18.339 L7.63,12.854 L9.65,11.826 L9.25,14.082 L5.17,19.574 L7.36,19.989 L11,15.102 L14.6,19.997 L16.8,19.59 L12.74,14.082 L12.34,11.826 L14.34,12.846 L18.4,18.371 L19.4,16.33 L17,13.061 L21,13.061 L22,11.02 L15.23,11.02 Z";
    }
}

component IconButton inherits Rectangle {
    in property <string> kind;
    callback clicked();

    width: 40px;
    height: 40px;
    background: transparent;

    touch := TouchArea {
        x: 0;
        y: 0;
        width: parent.width;
        height: parent.height;
        clicked => { root.clicked(); }
    }

    states [
        hover when touch.has-hover : { background: #ffffff22; }
        pressed when touch.pressed : { background: #ffffff44; }
    ]

    animate background { duration: 120ms; easing: ease-in-out; }

    if (root.kind == "minimize") : Path {
        x: (parent.width - 12px) / 2;
        y: (parent.height - 2px) / 2;
        width: 12px;
        height: 2px;
        fill: #ffffff;
        viewbox-width: 12;
        viewbox-height: 2;
        commands: "M0,0 L12,0 L12,2 L0,2 Z";
    }

    if (root.kind == "close") : Path {
        x: (parent.width - 12px) / 2;
        y: (parent.height - 12px) / 2;
        width: 12px;
        height: 12px;
        fill: #ffffff;
        viewbox-width: 12;
        viewbox-height: 12;
        commands: "M11.4,1.4 L10.6,0.6 L6,5.2 L1.4,0.6 L0.6,1.4 L5.2,6 L0.6,10.6 L1.4,11.4 L6,6.8 L10.6,11.4 L11.4,10.6 L6.8,6 Z";
    }

    if (root.kind == "coffee") : Rectangle {
        x: 10px;
        y: 11px;
        width: 20px;
        height: 18px;
        background: transparent;

        Rectangle {
            x: 0;
            y: 2px;
            width: 14px;
            height: 10px;
            border-radius: 2px;
            background: #ffffff;
        }

        Rectangle {
            x: 12px;
            y: 3px;
            width: 6px;
            height: 8px;
            border-width: 2px;
            border-color: #ffffff;
            border-radius: 4px;
            background: transparent;
        }

        Rectangle {
            x: -1px;
            y: 14px;
            width: 18px;
            height: 2px;
            border-radius: 1px;
            background: #ffffff;
        }
    }
}

component RetryButton inherits Rectangle {
    callback clicked();
    width: 48px;
    height: 18px;
    background: #ffffff22;
    border-radius: 3px;

    touch := TouchArea {
        x: 0;
        y: 0;
        width: parent.width;
        height: parent.height;
        clicked => { root.clicked(); }
    }

    states [
        pressed when touch.pressed : { background: #ffffff44; }
    ]

    animate background { duration: 120ms; easing: ease-in-out; }

    Text {
        text: "Retry";
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2 - 1px;
        font-size: 11px;
        color: #ffffff;
    }
}

component LitraSlider inherits Rectangle {
    in-out property <float> value;
    in property <float> minimum: 0.0;
    in property <float> maximum: 100.0;
    callback changed(float);

    height: 28px;
    background: #00000000;

    property <float> safe_range: max(1.0, maximum - minimum);
    property <length> track_width: root.width;
    property <length> knob_size: 14px;
    property <float> display_value: touch.pressed ? touch.drag_value : value;
    property <length> filled_width: clamp(track_width * (display_value - minimum) / safe_range, 0px, track_width);

    track := Rectangle {
        x: 0;
        y: (parent.height - 4px) / 2;
        width: root.track_width;
        height: 4px;
        border-radius: 2px;
        background: #ffffff55;
    }

    Rectangle {
        x: track.x;
        y: track.y;
        width: root.filled_width;
        height: track.height;
        border-radius: 2px;
        background: #ffffff;
        animate width { duration: 120ms; easing: ease-in-out; }
    }

    knob := Rectangle {
        width: root.knob_size;
        height: root.knob_size;
        border-radius: root.knob_size / 2;
        background: #ffffff;
        x: root.filled_width - (root.knob_size / 2);
        y: (parent.height - self.height) / 2;
        animate x { duration: 120ms; easing: ease-in-out; }
    }

    touch := TouchArea {
        x: 0;
        y: 0;
        width: parent.width;
        height: parent.height;
        property <float> drag_value: 0.0;
        pointer-event(event) => {
            if (event.button != PointerEventButton.left) {
                return;
            }
            if (event.kind == PointerEventKind.down) {
                drag_value = clamp(
                    root.minimum + touch.mouse-x * root.safe_range / root.track_width,
                    root.minimum,
                    root.maximum
                );
                root.changed(drag_value);
            }
            if (event.kind == PointerEventKind.up) {
                root.value = drag_value;
            }
        }
        moved => {
            if (!self.pressed) {
                return;
            }
            drag_value = clamp(
                root.minimum + touch.mouse-x * root.safe_range / root.track_width,
                root.minimum,
                root.maximum
            );
            root.changed(drag_value);
        }
    }
}

component LitraSwitch inherits Rectangle {
    in-out property <bool> checked: false;
    callback toggled(bool);

    width: 38px;
    height: 20px;
    background: transparent;

    track := Rectangle {
        x: 0;
        y: 2px;
        width: 37px;
        height: 16px;
        border-radius: 8px;
        background: root.checked ? #ffffffcc : #fe8855;
        animate background { duration: 140ms; easing: ease-in-out; }
    }

    knob := Rectangle {
        width: 20px;
        height: 20px;
        border-radius: 10px;
        background: #ffffff;
        x: root.checked ? (track.width - self.width + 1px) : 0px;
        y: 0px;
        drop-shadow-offset-x: 1px;
        drop-shadow-offset-y: 1px;
        drop-shadow-blur: 4px;
        drop-shadow-color: #00000033;
        animate x { duration: 140ms; easing: ease-in-out; }
    }

    TouchArea {
        x: 0;
        y: 0;
        width: parent.width;
        height: parent.height;
        clicked => {
            root.checked = !root.checked;
            root.toggled(root.checked);
        }
    }
}

component ToggleRow inherits Rectangle {
    in property <string> label: "";
    in-out property <bool> value: false;
    callback toggled(bool);

    height: 28px;
    background: #00000000;

    LitraSwitch {
        x: 0;
        y: (parent.height - self.height) / 2;
        checked <=> root.value;
        toggled(value) => { root.toggled(value); }
    }

    Text {
        text: root.label;
        x: 64px;
        y: (parent.height - self.height) / 2;
        font-size: 13px;
        color: #ffffff;
    }
}

component TitleBar inherits Rectangle {
    callback minimize();
    callback close();
    callback donate();
    callback start_drag();

    background: #fe6017;
    drop-shadow-offset-x: 0px;
    drop-shadow-offset-y: 4px;
    drop-shadow-blur: 4px;
    drop-shadow-color: #00000033;

    drag_area := TouchArea {
        x: 0;
        y: 0;
        width: parent.width - 120px;
        height: parent.height;
        pointer-event(event) => {
            if (event.button == PointerEventButton.left && event.kind == PointerEventKind.down) {
                root.start_drag();
            }
        }
    }

    Text {
        text: "LITRA";
        x: 16px;
        y: (parent.height - self.height) / 2;
        font-size: 18px;
        font-weight: 800;
        color: #ffffff;
    }

    Text {
        text: "GLOW";
        x: 74px;
        y: (parent.height - self.height) / 2;
        font-size: 18px;
        font-weight: 200;
        color: #ffffffcc;
    }

    IconButton {
        x: parent.width - 120px;
        y: 4px;
        kind: "coffee";
        clicked => { root.donate(); }
    }

    IconButton {
        x: parent.width - 80px;
        y: 4px;
        kind: "minimize";
        clicked => { root.minimize(); }
    }

    IconButton {
        x: parent.width - 40px;
        y: 4px;
        kind: "close";
        clicked => { root.close(); }
    }
}

component ControlPanel inherits Rectangle {
    in property <string> error;
    in-out property <float> brightness;
    in-out property <float> temperature;
    in-out property <bool> power;
    callback brightness_changed(float);
    callback temperature_changed(float);
    callback power_toggled(bool);
    callback retry_connect();

    background: #ff590d;
    border-radius: 2px;
    drop-shadow-offset-x: 1px;
    drop-shadow-offset-y: 1px;
    drop-shadow-blur: 4px;
    drop-shadow-color: #00000033;

    property <length> pad: 16px;
    property <length> row_height: 28px;
    property <length> spacing: 14px;
    property <length> error_offset: error != "" ? 18px : 0px;

    Rectangle {
        x: pad;
        y: pad;
        width: parent.width - (pad * 2);
        height: parent.height - (pad * 2);
        background: transparent;

        if (root.error != "") : Rectangle {
            x: 0;
            y: 0;
            width: parent.width;
            height: 18px;
            background: transparent;

            Text {
                text: root.error;
                x: 0;
                y: 0;
                font-size: 12px;
                color: #ffffff;
            }

            RetryButton {
                x: parent.width - 48px;
                y: 0;
                clicked => { root.retry_connect(); }
            }
        }

        HorizontalLayout {
            x: 0;
            y: root.error_offset;
            width: parent.width;
            height: root.row_height;
            spacing: 8px;
            alignment: center;

            DimmerIcon {
                y: (parent.height - self.height) / 2;
            }

            LitraSlider {
                width: parent.width - 62px;
                height: root.row_height;
                minimum: 20.0;
                maximum: 250.0;
                value <=> root.brightness;
                changed(value) => {
                    root.brightness_changed(value);
                }
            }

            BrighterIcon {
                y: (parent.height - self.height) / 2;
            }
        }

        HorizontalLayout {
            x: 0;
            y: root.error_offset + root.row_height + root.spacing;
            width: parent.width;
            height: root.row_height;
            spacing: 8px;
            alignment: center;

            WarmerIcon {
                y: (parent.height - self.height) / 2;
            }

            LitraSlider {
                width: parent.width - 52px;
                height: root.row_height;
                minimum: 2700.0;
                maximum: 6500.0;
                value <=> root.temperature;
                changed(value) => {
                    root.temperature_changed(value);
                }
            }

            ColderIcon {
                y: (parent.height - self.height) / 2;
            }
        }

        ToggleRow {
            x: 0;
            y: root.error_offset + (root.row_height + root.spacing) * 2;
            width: parent.width;
            height: root.row_height;
            label: "Power";
            value <=> root.power;
            toggled(value) => {
                root.power_toggled(value);
            }
        }
    }
}

export component AppWindow inherits Window {
    width: 400px;
    height: 230px;
    no-frame: true;
    resize-border-width: 0px;
    background: #ff4f01;
    title: "Litra Glow";

    in-out property <float> brightness: 150.0;
    in-out property <float> temperature: 4500.0;
    in-out property <bool> power: false;
    in property <string> error: "";

    callback brightness_changed(float);
    callback temperature_changed(float);
    callback power_toggled(bool);
    callback retry_connect();
    callback minimize();
    callback close();
    callback donate();
    callback start_drag();

    Rectangle {
        width: parent.width;
        height: parent.height;
        background: #ff4f01;
    }

    TitleBar {
        x: 0;
        y: 0;
        width: parent.width;
        height: 48px;
        minimize => { root.minimize(); }
        close => { root.close(); }
        donate => { root.donate(); }
        start_drag => { root.start_drag(); }
    }

    ControlPanel {
        x: 16px;
        y: 56px;
        width: parent.width - 32px;
        height: parent.height - 72px;
        error: root.error;
        brightness <=> root.brightness;
        temperature <=> root.temperature;
        power <=> root.power;
        brightness_changed(value) => { root.brightness_changed(value); }
        temperature_changed(value) => { root.temperature_changed(value); }
        power_toggled(value) => { root.power_toggled(value); }
        retry_connect => { root.retry_connect(); }
    }
}
